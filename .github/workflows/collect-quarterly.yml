name: ðŸ“Š Quarterly Financial Data (ë¶„ê¸°ë³„)

on:
  # ë¶„ê¸°ë³„ ì‹¤í–‰: 1/4/7/10ì›” ì²«ì§¸ì£¼ ì¼ìš”ì¼ ì˜¤ì „ 10ì‹œ KST (UTC 01:00)
  schedule:
    - cron: '0 1 1-7 1,4,7,10 0'

  # ìˆ˜ë™ ì‹¤í–‰
  workflow_dispatch:
    inputs:
      force_update:
        description: 'ì „ì²´ ì¢…ëª© ê°•ì œ ì—…ë°ì´íŠ¸'
        required: false
        default: 'false'
        type: boolean

env:
  PYTHON_VERSION: '3.11'

jobs:
  quarterly-collection:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: ðŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r backend/requirements.txt

      - name: ðŸ“ˆ Collect financial statements
        run: |
          python scripts/collect_financials.py
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          FORCE_UPDATE: ${{ github.event.inputs.force_update }}

      - name: ðŸ’° Collect financial ratios
        run: |
          python scripts/collect_ratios.py
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}

      - name: ðŸ­ Update sector averages
        run: |
          python scripts/update_sector_averages.py
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}

      - name: ðŸ”„ Recalculate fundamental scores
        run: |
          python scripts/update_fundamental_scores.py
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}

      - name: ðŸ“ Summary
        if: always()
        run: |
          echo "## ðŸ“Š Quarterly Collection Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date '+%Y-%m-%d %H:%M:%S KST' -d '+9 hours')" >> $GITHUB_STEP_SUMMARY
          echo "- **Force Update**: ${{ github.event.inputs.force_update || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

      - name: ðŸš¨ Notify on failure
        if: failure()
        run: |
          echo "::error::Quarterly collection failed!"
